<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facial Behavior Recognition Dashboard (Flask Integrated)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="left-side">
            <div class="box graph-box">
                <h2>Your Emotional Graph</h2>
                <canvas id="emotionChart"></canvas>
            </div>
            <div class="box log-box">
                <h3>User Log</h3>
                <p>Welcome back! Last seen: 25 May 2025</p>
                <p id="currentTimeLog"></p>
            </div>
        </div>

        <div class="right-side">
            <div class="box camera-box">
                <img id="flaskVideoFeed" src="{{ url_for('video_feed') }}" alt="Webcam Feed" style="width: 100%; max-width: 640px; height: auto; border-radius: 10px;" />
                <img id="imageUploadPreview" alt="Uploaded Image Preview" style="display:none;" />
                <div id="cameraOffMessage" class="camera-off-message">Camera is not on or feed stopped.</div>

                <div class="button-area">
                    <button onclick="startFlaskCamera()">Start Camera</button>
                    <button onclick="stopFlaskCamera()">Stop Camera</button>
                    <button onclick="uploadImage()">Upload Image</button>
                    <input type="file" id="imageUpload" accept="image/*">
                </div>
            </div>
            <div class="box prediction-box">
                <h3>Prediction</h3>
                <p id="predictionText">Detecting emotion...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='chart.js') }}"></script>

    <script>
        const flaskVideoFeed = document.getElementById('flaskVideoFeed');
        const imageInput = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imageUploadPreview');
        const cameraOffMessage = document.getElementById('cameraOffMessage');

        function updateDisplay(mode) {
            flaskVideoFeed.style.display = 'none';
            imagePreview.style.display = 'none';
            cameraOffMessage.style.display = 'none';

            if (mode === 'flask_video') {
                flaskVideoFeed.style.display = 'block';
            } else if (mode === 'image_preview') {
                imagePreview.style.display = 'block';
            } else if (mode === 'camera_off') {
                cameraOffMessage.style.display = 'flex';
            }
        }

        function startFlaskCamera() {
            flaskVideoFeed.src = "{{ url_for('video_feed') }}";
            updateDisplay('flask_video');
        }

        function stopFlaskCamera() {
            flaskVideoFeed.src = "";
            updateDisplay('camera_off');

            fetch('/stop_feed')
                .then(response => {
                    if (response.ok) {
                        console.log('Flask video feed stopped successfully on backend.');
                    } else {
                        console.error('Failed to stop Flask video feed on backend.');
                    }
                })
                .catch(error => {
                    console.error('Error sending stop signal to Flask backend:', error);
                });
        }

        function uploadImage() {
            imageInput.click();
        }

        imageInput.addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    stopFlaskCamera();
                    imagePreview.src = e.target.result;
                    updateDisplay('image_preview');
                };
                reader.readAsDataURL(file);
            }
        });

        // ✅ Live prediction updater
        function updateEmotionPrediction() {
            fetch('/get_emotion')
                .then(response => response.json())
                .then(data => {
                    const emotion = data.emotion;
                    const emojiMap = {
                        "Happy": "😄",
                        "Sad": "😢",
                        "Angry": "😠",
                        "Surprise": "😲",
                        "Neutral": "😐",
                        "Fear": "😱",
                        "Disgust": "🤢"
                    };
                    const emoji = emojiMap[emotion] || "";
                    document.getElementById("predictionText").textContent = `You look ${emotion} ${emoji}`;
                })
                .catch(error => {
                    console.error('Error fetching emotion:', error);
                });
        }

        setInterval(updateEmotionPrediction, 2000);

        document.addEventListener('DOMContentLoaded', () => {
            updateDisplay('camera_off');

            const ctx = document.getElementById('emotionChart').getContext('2d');
            const emotionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Happiness Level',
                        data: [65, 59, 80, 81, 56, 55, 40],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            const currentTimeLog = document.getElementById('currentTimeLog');
            if (currentTimeLog) {
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true, timeZoneName: 'short' };
                currentTimeLog.textContent = `Current Time: ${now.toLocaleString('en-US', options)}`;
            }
        });
    </script>
</body>
</html>
